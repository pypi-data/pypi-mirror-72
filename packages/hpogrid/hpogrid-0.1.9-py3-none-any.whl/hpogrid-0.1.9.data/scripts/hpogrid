#!python

import argparse
import json
import sys, os


try:
    import hpogrid
    from hpogrid.components import Configurator
except:
    raise ImportError('Cannot import hpogrid module. Try source setupenv.sh first.')

kTestHelp = ''
kCommand_HPOConfig = 'hpo_config'
kCommand_GridConfig = 'grid_config'
kCommand_ModelConfig = 'model_config'
kCommand_SearchSpace = 'search_space'
kCommand_Project = 'project'
kCommand_PandaStatus = 'tasks'
kCommand_RunProject = 'run'
kCommand_RunProjectLocally = 'local_run'
kCommand_SiteInfo = 'sites'
kCommand_Report = 'report'
kCommand_Generate = 'generate'

kCommandList = [kCommand_HPOConfig, kCommand_GridConfig, kCommand_ModelConfig,
                kCommand_SearchSpace, kCommand_Project, kCommand_PandaStatus,
                kCommand_SiteInfo, kCommand_RunProjectLocally,
                kCommand_RunProject, kCommand_Report, kCommand_Generate]


class HPOGridCommander(object):
    def __init__(self):
        parser = argparse.ArgumentParser(
            description='Tool for Hyperparameter Optimization on the Grid',
            usage='''hpogrid <command> [<args>]''')
        parser.add_argument('command', help='Subcommand to run', choices=kCommandList)
        # parse_args defaults to [1:] for args, but you need to
        # exclude the rest of the args too, or validation will fail        
        args = parser.parse_args(sys.argv[1:2])
        if not hasattr(self, args.command):
                    print('Unrecognized command')
                    parser.print_help()
                    exit(1)
        getattr(self, args.command)()

    def hpo_config(self):
        Configurator.HPOConfiguration()

    def grid_config(self):
        Configurator.GridConfiguration()

    def search_space(self):
        Configurator.SearchSpaceConfiguration()

    def model_config(self):
        Configurator.ModelConfiguration()

    def project(self):
        Configurator.ProjectConfiguration()
    
    def tasks(self):
        from hpogrid.components import PandaTaskManager
        PandaTaskManager.PandaTaskManager(True)

    def run(self):
        from hpogrid.components import GridHandler
        GridHandler.GridHandler()

    def local_run(self):
        from hpogrid.components import JobHandler
        JobHandler.JobHandler()

    def sites(self):
        from hpogrid.utils import InfoTool
        InfoTool.GridSiteInfo()

    def report(self):
        from hpogrid.components import HPOReporter
        HPOReporter.HPOTaskHandle()
        
    def generate(self):
        from hpogrid.idds_interface.steering import SteeringIDDS
        SteeringIDDS()
    

if __name__ == '__main__':
    HPOGridCommander()